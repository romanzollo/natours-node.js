const express = require('express');

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É morgan ‚Äî –ª–æ–≥–≥–µ—Ä HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
const morgan = require('morgan');

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ç—É—Ä–æ–≤ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
const tourRouter = require('./routes/tourRoutes');
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
const userRouter = require('./routes/userRoutes');

// –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Express
const app = express();

// ==================== MIDDLEWARE ====================
// Middleware ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –º–∞—Ä—à—Ä—É—Ç—ã

// –õ–æ–≥–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–∞—Ö (–º–µ—Ç–æ–¥, –ø—É—Ç—å, —Å—Ç–∞—Ç—É—Å, –≤—Ä–µ–º—è) ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
app.use(morgan('dev'));

// –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π middleware: –ø–∞—Ä—Å–∏—Ç —Ç–µ–ª–æ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ JSON –≤ –æ–±—ä–µ–∫—Ç req.body
// –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ POST/PATCH –∏ –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å JSON
app.use(express.json());

// –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ middleware
// –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ, –≤—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
app.use((req, res, next) => {
  console.log('Hello from the middleware üëã');
  next(); // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º next(), —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É middleware –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç—É
});

// –î—Ä—É–≥–æ–π –ø—Ä–∏–º–µ—Ä middleware: –¥–æ–±–∞–≤–ª—è–µ–º –∫ –∑–∞–ø—Ä–æ—Å—É —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
app.use((req, res, next) => {
  req.requestTime = new Date().toISOString(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ–±—ä–µ–∫—Ç–µ req
  next();
});

// ==================== –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø ====================

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ç—É—Ä–æ–≤ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É '/api/v1/tours'
// –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –∏–∑ tourRouter –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Å —ç—Ç–æ–≥–æ –ø—É—Ç–∏
// –ù–∞–ø—Ä–∏–º–µ—Ä: GET /api/v1/tours, POST /api/v1/tours –∏ —Ç.–¥.
app.use('/api/v1/tours', tourRouter);

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É '/api/v1/users'
// –ù–∞–ø—Ä–∏–º–µ—Ä: GET /api/v1/users, DELETE /api/v1/users/5
app.use('/api/v1/users', userRouter);

module.exports = app;
